<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>TokoTani</title>
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <meta content="" name="keywords" />
    <meta content="" name="description" />

    <!-- Google Web Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@400;600&family=Raleway:wght@600;800&display=swap"
      rel="stylesheet"
    />

    <!-- Icon Font Stylesheet -->
    <link
      rel="stylesheet"
      href="https://use.fontawesome.com/releases/v5.15.4/css/all.css"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.4.1/font/bootstrap-icons.css"
      rel="stylesheet"
    />

    <!-- Libraries Stylesheet -->
    <link href="lib/lightbox/css/lightbox.min.css" rel="stylesheet" />
    <link href="lib/owlcarousel/assets/owl.carousel.min.css" rel="stylesheet" />

    <!-- Customized Bootstrap Stylesheet -->
    <link href="./bootstrap.min.css" rel="stylesheet" />

    <!-- Template Stylesheet -->
    <link href="../styles/cart_Buyer.css" rel="stylesheet" />

  </head>

  <body>
    <!-- Navbar start -->
    <div class="container-fluid fixed-top">
      <div class="container px-0">
        <nav class="navbar navbar-light bg-M navbar-expand-xl">
          <a href="index.html" class="navbar-brand">
            <h1 class="text-primary display-6">TokoTani</h1>
          </a>
          <div class="modal-body d-flex align-items-center">
            <div class="input-group w-75 mx-auto d-flex">
              <input
                type="search"
                class="form-control p-3"
                placeholder="keywords"
                aria-describedby="search-icon-1"
                id="search-input"
              />
              <span
                id="search-icon-1"
                class="input-group-text p-3"
                onclick="handleSearch('search-input')"
                ><i class="fa fa-search"></i
              ></span>
            </div>
          </div>
          <button
            class="navbar-toggler py-2 px-3"
            type="button"
            data-bs-toggle="collapse"
            data-bs-target="#navbarCollapse"
          >
            <span class="fa fa-bars text-primary"></span>
          </button>
          <div class="collapse navbar-collapse bg-M" id="navbarCollapse">
            <div class="d-flex ms-auto m-3 me-0">
              <div class="dropdown my-auto" id="profile"></div>
            </div>
          </div>
        </nav>
      </div>
    </div>
    <!-- Navbar End -->

    <!-- Cart Page Start -->
    <div class="container-fluid py-5">
      <div class="container py-5">
        <div class="table-responsive">
          <form id="cart-form">
            <table class="table">
              <thead>
                <tr>
                  <th scope="col" class="col">Select</th>
                  <th scope="col" class="col">Products</th>
                  <th scope="col" class="col">Name</th>
                  <th scope="col" class="col">Price</th>
                  <th scope="col" class="col">Quantity</th>
                  <th scope="col" class="col">Total</th>
                  <th scope="col" class="col">Handle</th>
                </tr>
              </thead>
              <tbody id="cart-items">
                <!-- Cart items will be injected here dynamically -->
              </tbody>
            </table>
          </form>
        </div>

        <!-- Address Selection and New Address Form -->
        <div class="row g-4">
          <div class="col-12">
            <h5 class="mb-3">Select Shipping Address</h5>
            <select id="address-select" class="form-select mb-4">
              <!-- Addresses will be populated dynamically -->
            </select>
            <button
              class="btn btn-secondary mb-4"
              type="button"
              data-bs-toggle="collapse"
              data-bs-target="#new-address-form"
            >
              Add New Address
            </button>
            <div id="new-address-form" class="collapse">
              <form id="address-form">
                <div class="mb-3">
                  <label for="address_line1" class="form-label"
                    >Address Line 1</label
                  >
                  <input
                    type="text"
                    class="form-control"
                    id="address_line1"
                    placeholder="Enter address line 1"
                  />
                </div>
                <div class="mb-3">
                  <label for="address_line2" class="form-label"
                    >Address Line 2</label
                  >
                  <input
                    type="text"
                    class="form-control"
                    id="address_line2"
                    placeholder="Enter address line 2"
                  />
                </div>
                <div class="mb-3">
                  <label for="city" class="form-label">City</label>
                  <input
                    type="text"
                    class="form-control"
                    id="city"
                    placeholder="Enter city"
                  />
                </div>
                <div class="mb-3">
                  <label for="province" class="form-label">Province</label>
                  <input
                    type="text"
                    class="form-control"
                    id="province"
                    placeholder="Enter province"
                  />
                </div>
                <div class="mb-3">
                  <label for="postal_code" class="form-label"
                    >Postal Code</label
                  >
                  <input
                    type="text"
                    class="form-control"
                    id="postal_code"
                    placeholder="Enter postal code"
                  />
                </div>
                <div class="mb-3">
                  <label for="country" class="form-label">Country</label>
                  <input
                    type="text"
                    class="form-control"
                    id="country"
                    placeholder="Enter country"
                  />
                </div>
                <button class="btn btn-primary" type="submit">
                  Add Address
                </button>
              </form>
            </div>
          </div>
        </div>

        <div class="row g-4 justify-content-end">
          <div class="col-8"></div>
          <div class="col-sm-8 col-md-7 col-lg-6 col-xl-4">
            <div class="bg-light rounded">
              <div class="p-4">
                <h1 class="display-6 mb-4">
                  Cart <span class="fw-normal">Total</span>
                </h1>
                <div class="row">
                  <div class="col">
                    <h5 class="mb-0">Subtotal:</h5>
                  </div>
                  <div class="col text-end">
                    <p class="mb-0" id="subtotal">0</p>
                  </div>
                </div>
                <div class="row">
                  <div class="col">
                    <h5 class="mb-0">Shipping</h5>
                  </div>
                  <div class="col text-end">
                    <p class="mb-0">Flat rate: 10.000</p>
                  </div>
                </div>
                <p class="mb-0 text-end" id="shipping-to">Shipping to :</p>
              </div>
              <div
                class="py-4 mb-4 border-top border-bottom d-flex justify-content-between"
              >
                <h5 class="mb-0">Total</h5>
                <p class="mb-0" id="total">0</p>
              </div>
              <button
                class="btn border-secondary rounded-pill px-4 py-3 text-primary text-uppercase mb-4 ms-4"
                type="button"
                id="checkout"
              >
                Proceed Checkout
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
    <!-- Cart Page End -->
    <!-- Modal for order processing -->
    <div
      class="modal fade"
      id="orderProcessingModal"
      tabindex="-1"
      aria-labelledby="orderProcessingModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="orderProcessingModalLabel">
              Order Processing
            </h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <div class="modal-body">
            <p>
              Your order has been successfully placed. The seller will now
              process your order.
            </p>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-primary"
              data-bs-dismiss="modal"
            >
              Close
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Back to Top -->
    <a
      href="#"
      class="btn btn-primary border-3 border-primary rounded-circle back-to-top"
      ><i class="fa fa-arrow-up"></i
    ></a>

    <!-- JavaScript Libraries -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.4/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="lib/easing/easing.min.js"></script>
    <script src="lib/waypoints/waypoints.min.js"></script>
    <script src="lib/lightbox/js/lightbox.min.js"></script>
    <script src="lib/owlcarousel/owl.carousel.min.js"></script>

    <!-- Template Javascript -->
    <script src="js/main.js"></script>

    <!-- Custom Script to Fetch and Display Cart Data -->
    <script>
      function updateCartItemQuantity(itemId, newQuantity) {
        console.log("Updating quantity for item ID:", itemId);
        console.log("New quantity:", newQuantity);

        const userToken = localStorage.getItem("userToken");
        const decodedToken = decodeJwt(userToken);

        if (!decodedToken || !decodedToken.userID) {
          console.error("User ID not found in decoded token.");
          return;
        }

        // Make the AJAX request to update the cart item quantity
        $.ajax({
          url: `http://localhost:3330/api/products/cart/${decodedToken.userID}/${itemId}`,
          method: "PUT",
          contentType: "application/json",
          data: JSON.stringify({ quantity: newQuantity }),
          success: function (response) {
            console.log("Quantity updated successfully:", response);
            // Fetch the updated cart data
            fetchCart();
          },
          error: function (error) {
            console.error("Error updating quantity:", error);
          },
        });
      }

      function postCheckout(selectedItems, addressId) {
        console.log("Checkout button clicked");
        console.log("Selected items for checkout:", selectedItems);

        // Decode the JWT token to get the user ID
        const userToken = localStorage.getItem("userToken");
        const decodedToken = decodeJwt(userToken);

        if (!decodedToken || !decodedToken.userID) {
          console.error("User ID not found in decoded token.");
          return;
        }

        // Define the checkout endpoint URL
        const checkoutEndpoint = `http://localhost:3330/api/products/checkout/${decodedToken.userID}`;

        // Prepare the request payload
        const requestData = {
          items: selectedItems,
          address_id: addressId, // Include the selected address ID in the payload
        };

        // Send the POST request to the checkout endpoint
        $.ajax({
          url: checkoutEndpoint,
          method: "POST",
          contentType: "application/json",
          data: JSON.stringify(requestData),
          success: function (response) {
            console.log("Checkout successful:", response);
            // Show the order processing modal
            $("#orderProcessingModal").modal("show");
            // Optionally, you can redirect to a confirmation page or handle other UI updates here
          },
          error: function (error) {
            console.error("Checkout error:", error);
            // Display error message
          },
        });
      }

      // Add event listener for checkout button
      document
        .getElementById("checkout")
        .addEventListener("click", function (event) {
          event.preventDefault(); // Prevent form submission behavior
          handleCheckout(); // Call your checkout function
        });

      // Function to handle checkout
      function handleCheckout() {
        // Get all the selected checkboxes
        const selectedCheckboxes = document.querySelectorAll(
          'input[name="select"]:checked'
        );

        // Collect the selected item IDs
        const selectedItems = Array.from(selectedCheckboxes).map(
          (checkbox) => checkbox.value
        );

        // Get the selected address ID
        const addressId = document.getElementById("address-select").value;

        if (selectedItems.length > 0) {
          console.log("Selected items:", selectedItems);
          postCheckout(selectedItems, addressId); // Pass the selected address ID to the checkout function
        } else {
          console.log("No items selected for checkout.");
        }
      }

      // Function to handle modal close event
      $("#orderProcessingModal").on("hidden.bs.modal", function () {
        // Optionally perform actions when modal is closed
      });

      function handleCheckout() {
        // Get all the selected checkboxes
        const selectedCheckboxes = document.querySelectorAll(
          'input[name="select"]:checked'
        );

        // Collect the selected item IDs
        const selectedItems = Array.from(selectedCheckboxes).map(
          (checkbox) => checkbox.value
        );

        // Get the selected address ID
        const addressId = document.getElementById("address-select").value;

        if (selectedItems.length > 0) {
          console.log("Selected items:", selectedItems);
          postCheckout(selectedItems, addressId); // Pass the selected address ID to the checkout function
        } else {
          console.log("No items selected for checkout.");
        }
      }

      function fetchCart() {
        const userToken = localStorage.getItem("userToken");
        const decodedToken = decodeJwt(userToken);

        if (!decodedToken || !decodedToken.userID) {
          console.error("User ID not found in decoded token.");
          return;
        }

        // Fetch cart items
        $.ajax({
          url: `http://localhost:3330/api/products/cart/${decodedToken.userID}`,
          method: "GET",
          contentType: "application/json",
          success: function (response) {
            const cartItems = response.cartItems;
            const cartItemsContainer = $("#cart-items");
            cartItemsContainer.empty();

            let subtotal = 0;

            cartItems.forEach((item) => {
              const total = item.price * item.quantity;
              subtotal += total;

              // Format price to IDR
              const formattedPrice = formatToIDR(item.price);
              const formattedTotal = formatToIDR(total);

              const cartItemHTML = `
                <tr>
                  <td class="align-middle">
                    <input
                      type="checkbox"
                      class="form-check-input"
                      name="select"
                      value="${item.product_id}"
                    />
                  </td>
                  <td class="align-middle"><img src="${item.picture_path}" alt="${item.name}" style="width: 50px;"></td>
                  <td class="align-middle">${item.name}</td>
                  <td class="align-middle">${formattedPrice}</td>
                  <td class="align-middle">
                    <input
                      type="number"
                      class="form-control"
                      value="${item.quantity}"
                      min="1"
                      onchange="updateCartItemQuantity('${item.product_id}', this.value)"
                    />
                  </td>
                  <td class="align-middle">${formattedTotal}</td>
                  <td class="align-middle">
                    <button
                      class="btn btn-sm btn-danger"
                      onclick="deleteCartItem('${item.product_id}')"
                    >
                      <i class="fa fa-times"></i>
                    </button>
                  </td>
                </tr>
              `;
              cartItemsContainer.append(cartItemHTML);
            });

            // Format subtotal and total to IDR
            const formattedSubtotal = formatToIDR(subtotal);
            $("#subtotal").text(formattedSubtotal);
            $("#total").text(formatToIDR(subtotal + 10000)); // Assuming flat rate shipping is 10,000
          },
          error: function (error) {
            console.error("Error fetching cart items:", error);
          },
        });
      }

      // Function to fetch user addresses
      // Function to fetch user addresses
      function fetchAddresses() {
        const userToken = localStorage.getItem("userToken");
        const decodedToken = decodeJwt(userToken);

        if (!decodedToken || !decodedToken.userID) {
          console.error("User ID not found in decoded token.");
          return;
        }

        // Fetch user addresses
        $.ajax({
          url: `http://localhost:3330/api/users/address/${decodedToken.userID}`,
          method: "GET",
          contentType: "application/json",
          success: function (response) {
            if (response && Array.isArray(response)) {
              // Ensure response is an array
              const addressSelect = $("#address-select");
              addressSelect.empty();

              response.forEach((address) => {
                const fullAddress = `${address.address_line1}, ${address.address_line2}, ${address.city}, ${address.province}, ${address.country}`;
                const option = `<option value="${address.id}">${fullAddress}</option>`;
                addressSelect.append(option);
              });
            } else {
              console.error("Invalid or empty addresses response:", response);
              // Handle no addresses found scenario (e.g., display a message or handle gracefully)
            }
          },
          error: function (error) {
            console.error("Error fetching addresses:", error);
            // Handle error scenario (e.g., display an error message or handle gracefully)
          },
        });
      }

      // Call fetchAddresses() to load addresses initially
      $(document).ready(function () {
        fetchAddresses();
      });

      // Function to format number to IDR
      function formatToIDR(number) {
        return new Intl.NumberFormat("id-ID", {
          style: "currency",
          currency: "IDR",
        }).format(number);
      }
      // Add event listener for checkout button
      document
        .getElementById("checkout")
        .addEventListener("click", handleCheckout);

      // Fetch cart and addresses on page load
      $(document).ready(function () {
        fetchCart();
      });

      // Add new address
      $("#address-form").on("submit", function (event) {
        event.preventDefault();

        const userToken = localStorage.getItem("userToken");
        const decodedToken = decodeJwt(userToken);

        if (!decodedToken || !decodedToken.userID) {
          console.error("User ID not found in decoded token.");
          return;
        }

        const address_line1 = $("#address_line1").val();
        const address_line2 = $("#address_line2").val();
        const city = $("#city").val();
        const province = $("#province").val();
        const postal_code = $("#postal_code").val();
        const country = $("#country").val();

        $.ajax({
          url: `http://localhost:3330/api/users/address/${decodedToken.userID}`,
          method: "POST",
          contentType: "application/json",
          data: JSON.stringify({
            user_id: decodedToken.userID,
            address_line1: address_line1,
            address_line2: address_line2,
            city: city,
            province: province,
            postal_code: postal_code,
            country: country,
          }),
          success: function (response) {
            console.log("Address added successfully:", response);
            fetchCart(); // Refresh addresses after adding a new one
          },
          error: function (error) {
            console.error("Error adding address:", error);
          },
        });
      });

      function deleteCartItem(itemId) {
        const userToken = localStorage.getItem("userToken");
        const decodedToken = decodeJwt(userToken);

        if (!decodedToken || !decodedToken.userID) {
          console.error("User ID not found in decoded token.");
          return;
        }

        $.ajax({
          url: `http://localhost:3330/api/products/cart/${decodedToken.userID}/${itemId}`,
          method: "DELETE",
          contentType: "application/json",
          success: function (response) {
            console.log("Item deleted successfully:", response);
            // Refresh the cart or update UI as needed
          },
          error: function (error) {
            console.error("Error deleting item:", error);
            // Handle error scenarios
          },
        });
      }

      function decodeJwt(token) {
        const base64Url = token.split(".")[1];
        const base64 = base64Url.replace(/-/g, "+").replace(/_/g, "/");
        const jsonPayload = decodeURIComponent(
          atob(base64)
            .split("")
            .map(function (c) {
              return "%" + ("00" + c.charCodeAt(0).toString(16)).slice(-2);
            })
            .join("")
        );
        return JSON.parse(jsonPayload);
      }
    </script>
  </body>
</html>
